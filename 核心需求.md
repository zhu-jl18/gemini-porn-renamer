# 核心需求

## 项目背景

利用大模型 Gemini 进行成人视频自动重命名。面向个人使用，通过 GPT-Load 本地代理访问 Gemini API（内置上万个 key 自动轮询）。

## 技术约束

### GPT-Load 配置
- **接口地址**：`http://localhost:3001/proxy/free`
- **鉴权 Key**：从 `.env` 文件配置（示例见 `.env.example`）
- **特性**：内置上万个 Gemini API Key，支持自动轮询和高并发

### 接口说明
GPT-Load 提供两种接口：
1. **OpenAI 兼容接口**（推荐）：在 `proxy/free/` 后添加 `/v1beta/openai`
   - 完整端点：`http://localhost:3001/proxy/free/v1beta/openai/chat/completions`
2. **Gemini 原生接口**：直接使用 `proxy/free/v1beta/models/{model}:generateContent`

详细对比参考：[docs/gptload-api.md](docs/gptload-api.md)

### 模型选择
- **Flash 模型**：`gemini-2.0-flash-exp`（标签分析）
- **Pro 模型**：`gemini-2.0-flash-thinking-exp`（命名生成）
- 充分利用多模态功能（视频帧 + 音频转录）

## 四大核心需求

### 1. 单视频处理为主
**目标**：每次只处理一个视频，清晰展示每一步的进度和输出结果。

**要求**：
- ✅ 可视化进度条（Rich 库）
- ✅ 每步输出可见（抽帧、转录、标签、候选名）
- ✅ 用户交互选择候选名
- ✅ 支持 dry-run 模式验证
- ✅ 所有操作记录审计日志

**工作流程**：
```
用户指定视频
    ↓
1. 抽帧 (ffmpeg)
    ↓
2. 转录 (faster-whisper, 可选)
    ↓
3. 标签分析 (Gemini Flash + 多模态)
    ↓
4. 生成候选名 (Gemini Pro)
    ↓
5. 用户选择
    ↓
6. 执行改名 (可选)
    ↓
7. 记录审计日志
```

**交互示例**：
```
候选文件名：
1. FALENO_FAL_Title_2021_Akari_1080p_WEB_JP_1a2b3c4d.mp4
2. Studio_Series_Name_2021_Actor_1080p_bd5e7a8f.mp4
3. ...

选择一个序号 (1-5)，或 0 跳过: 1
```

### 2. 目录扫描器
**目标**：递归扫描指定目录，识别需要处理的视频文件和乱码文件名。

**要求**：
- 📁 递归扫描（`pathlib.Path.rglob("*.mp4")`）
- 🔍 乱码文件名识别（使用 `chardet` 库检测编码）
- 🎯 文件过滤规则：
  - 扩展名白名单：`.mp4`, `.mkv`, `.avi`, `.wmv`
  - 文件大小阈值（排除小于 10MB 的文件）
  - 排除已处理文件（通过审计日志比对）
- 📊 扫描结果预览：
  ```
  扫描完成：
  - 总文件数：150
  - 乱码文件：23
  - 已处理：45
  - 待处理：82
  ```
- ✅ 用户确认后开始批处理

**CLI 命令设计**：
```powershell
# 扫描目录
.\.venv\Scripts\python.exe -m vrenamer.cli.main scan "X:\Videos" --preview

# 批处理扫描结果
.\.venv\Scripts\python.exe -m vrenamer.cli.main batch "X:\Videos" --concurrency 32
```

### 3. 高并发工作流
**目标**：充分利用 GPT-Load 上万 key 和自动轮询能力，支持批量并发处理。

**要求**：
- ⚡ 并发模型：`asyncio` + `asyncio.Semaphore`
- 🎛️ 并发控制：可配置（默认 32，最大 64）
- 🔄 GPT-Load 键轮询：自动负载均衡（客户端无需管理）
- 📊 批量进度跟踪：
  ```
  处理进度：[████████████░░░░░░░░] 62/120 (51%)
  成功：58 | 失败：4 | 队列：58
  
  当前任务：
  - Task 1: [分析] video_001.mp4
  - Task 2: [命名] video_015.mp4
  - Task 3: [改名] video_027.mp4
  ```
- 💾 断点续传：保存处理状态到 `logs/batch_state.json`
- 🔁 失败重试：指数退避（`backoff` 库）

**并发架构**：
```python
class WorkflowManager:
    def __init__(self, max_concurrency: int = 32):
        self.semaphore = asyncio.Semaphore(max_concurrency)
        self.client = GeminiClient(...)
    
    async def process_batch(self, videos: List[Path]):
        tasks = [self._process_one(v) for v in videos]
        results = await asyncio.gather(*tasks, return_exceptions=True)
        return results
    
    async def _process_one(self, video: Path):
        async with self.semaphore:
            # 单视频处理流程
            pass
```

**配置项**：
```env
MAX_CONCURRENCY=32      # 并发任务数
REQUEST_TIMEOUT=30      # 单个请求超时
RETRY=3                # 失败重试次数
```

### 4. 迭代优化机制
**目标**：收集误命名样本，持续优化提示词和命名策略。

**要求**：
- 📝 反馈收集：用户标记误命名样本
- 💾 样例管理：保存到 `examples/naming_samples.yaml`
- 🎯 Few-shot 注入：自动注入 prompt
- 🔬 A/B 测试：对比不同 prompt 策略
- 📈 效果评估：命名准确率统计

**样例格式**（`examples/naming_samples.yaml`）：
```yaml
samples:
  - input:
      frames: ["frame_001.jpg", "frame_002.jpg"]
      transcript: "对话内容..."
      tags:
        role_archetype: ["人妻"]
        scene_type: ["做爱"]
    expected_output: "FALENO_FAL_Title_2021_Akari_1080p_WEB_JP_1a2b3c4d.mp4"
    comment: "正确示例"
  
  - input:
      frames: [...]
      transcript: "..."
    actual_output: "Wrong_Name.mp4"
    expected_output: "Correct_Name.mp4"
    comment: "误命名，需要修正"
```

**CLI 命令设计**：
```powershell
# 收集反馈
.\.venv\Scripts\python.exe -m vrenamer.cli.main feedback \
  --video "X:\Videos\test.mp4" \
  --actual "Wrong_Name.mp4" \
  --expected "Correct_Name.mp4"

# 运行迭代优化
.\.venv\Scripts\python.exe -m vrenamer.cli.main iterate \
  --samples examples/naming_samples.yaml \
  --test-split 0.2
```

**迭代流程**：
```
1. 收集误命名样本 (feedback 命令)
    ↓
2. 分析错误模式 (人工或自动)
    ↓
3. 调整 prompt 策略
    ↓
4. 测试验证 (test-split 20%)
    ↓
5. 部署新 prompt
    ↓
6. 持续监控效果
```

## 命名规范

### 设计理念
**AI 创造性命名**，而非格式化模板。通过多种风格的命名，让用户选择最满意的。

### 命名风格系统

命名风格通过配置文件动态配置：`examples/naming_styles.yaml`

#### 内置风格

1. **中文描述性**（优雅含蓄）
   ```
   温泉旅馆的诱惑.mp4
   午后的秘密时光.mp4
   海边别墅的邂逅.mp4
   ```

2. **场景+角色**（具体描述）
   ```
   温泉旅馆_美丽人妻.mp4
   深夜办公室_女上司.mp4
   按摩店_新人技师.mp4
   ```

3. **角色+场景+动作**（详细叙事）
   ```
   人妻在温泉旅馆的秘密.mp4
   护士在医院值班的夜晚.mp4
   女教师放学后的补习.mp4
   ```

4. **P站风格**（英文直接）
   ```
   Hot MILF seduced in hotel.mp4
   Sexy nurse after night shift.mp4
   Beautiful wife cheating at home.mp4
   ```

5. **简洁标题**（短小精悍）
   ```
   温泉诱惑.mp4
   午夜秘密.mp4
   禁忌关系.mp4
   ```

6. **场景+演员**（可选演员名）
   ```
   温泉旅馆的诱惑_明日花绮罗.mp4
   午后的秘密时光_波多野结衣.mp4
   办公室加班.mp4  # 未识别演员时省略
   ```

### 风格配置格式

```yaml
styles:
  风格ID:
    name: "风格名称"
    description: "风格描述"
    language: "zh/en"
    format: "{命名格式说明}"
    examples:
      - "示例1"
      - "示例2"
    prompt_template: |
      给 AI 的提示词模板...
```

### 使用方式

#### CLI 指定风格
```powershell
# 使用默认风格组合（生成 5 个候选）
.\.venv\Scripts\python.exe -m vrenamer.cli.main run "test.mp4"

# 指定特定风格
.\.venv\Scripts\python.exe -m vrenamer.cli.main run "test.mp4" \
  --styles chinese_descriptive,pornhub_style

# 自定义风格文件
.\.venv\Scripts\python.exe -m vrenamer.cli.main run "test.mp4" \
  --style-config my_styles.yaml
```

#### 配置文件
`.env` 配置：
```env
# 默认使用的风格（逗号分隔）
NAMING_STYLES=chinese_descriptive,scene_role,pornhub_style,concise

# 风格配置文件路径
NAMING_STYLE_CONFIG=examples/naming_styles.yaml

# 每种风格生成候选数
CANDIDATES_PER_STYLE=1

# 总候选数
TOTAL_CANDIDATES=5
```

### 输出示例

用户处理一个视频时，会看到：

```
[✓] AI 分析完成

候选文件名（5个不同风格）：
1. [中文描述] 温泉旅馆的诱惑.mp4
2. [场景角色] 温泉旅馆_美丽人妻.mp4
3. [P站风格] Hot MILF seduced in hotel.mp4
4. [简洁标题] 温泉诱惑.mp4
5. [详细叙事] 人妻在温泉旅馆的秘密.mp4

选择一个序号 (1-5)，或 0 跳过: 1
```

### 命名规则

1. **非法字符替换**：`< > : " / \ | ? *` → `_`
2. **空白压缩**：多个空格/下划线 → 单个 `_`
3. **长度限制**：总长度不超过 80 字符（可配置）
4. **演员名可选**：未识别时可省略
5. **扩展名保留**：保持原视频扩展名（.mp4/.mkv/.avi）

## 原则与约束

### 开发原则
1. **环境隔离**：必须使用 Python 虚拟环境
2. **安全第一**：绝不提交 `.env` 和真实 Key
3. **文档同步**：代码变更必须更新文档
4. **简洁专业**：文档语言简洁清晰，禁止浮夸

### 性能要求
- **单视频处理**：< 30 秒（包括抽帧、分析、命名）
- **批量并发**：32 并发时，100 个视频 < 5 分钟
- **内存占用**：< 2GB（含 FFmpeg 和模型推理）

### 可靠性要求
- **失败重试**：网络错误自动重试 3 次，指数退避
- **错误降级**：多模态失败时降级到文本元数据分析
- **数据安全**：所有改名操作支持一键回滚

## 技术栈

- **Python**：3.10+
- **LLM 客户端**：httpx + pydantic
- **视频处理**：ffmpeg
- **音频转录**：faster-whisper（可选）
- **并发**：asyncio + Semaphore
- **CLI**：typer + rich
- **WebUI**：FastAPI + Jinja2（开发中）

## 参考资料

- **GPT-Load**：本地 Gemini 代理服务
- **Gemini API**：https://ai.google.dev/docs
- **OpenAI API**：https://platform.openai.com/docs/api-reference
